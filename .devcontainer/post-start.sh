#!/bin/bash
# .devcontainer/post-start.sh
# Script que se ejecuta cada vez que se inicia el DevContainer

set -e

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# FunciÃ³n para logging
log() {
    echo -e "${BLUE}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Verificar y actualizar dependencias si es necesario
check_dependencies() {
    log "Verificando dependencias..."
    
    cd /workspace
    
    # Verificar si package.json ha cambiado
    if [ -f "package.json" ]; then
        # Verificar si node_modules estÃ¡ actualizado
        if [ ! -d "node_modules" ] || [ "package.json" -nt "node_modules" ]; then
            log "Actualizando dependencias..."
            pnpm install
            log_success "Dependencias actualizadas"
        else
            log "Dependencias estÃ¡n actualizadas"
        fi
    fi
}

# Limpiar archivos temporales
cleanup_temp_files() {
    log "Limpiando archivos temporales..."
    
    cd /workspace
    
    # Limpiar archivos de build antiguos si existen
    [ -d ".astro" ] && rm -rf .astro
    
    # Limpiar logs antiguos
    find . -name "*.log" -type f -mtime +7 -delete 2>/dev/null || true
    
    log_success "Archivos temporales limpiados"
}

# Verificar configuraciÃ³n de Git
check_git_config() {
    log "Verificando configuraciÃ³n de Git..."
    
    # Verificar que el directorio sea seguro
    git config --global --add safe.directory /workspace 2>/dev/null || true
    
    # Mostrar configuraciÃ³n actual
    local git_user=$(git config --global user.name 2>/dev/null || echo "No configurado")
    local git_email=$(git config --global user.email 2>/dev/null || echo "No configurado")
    
    log "Git configurado como: $git_user <$git_email>"
    
    if [ "$git_user" = "Developer" ] || [ "$git_email" = "developer@cubatattoostudio.com" ]; then
        log_warning "Usando configuraciÃ³n de Git por defecto. Considera personalizarla:"
        echo "  git config --global user.name 'Tu Nombre'"
        echo "  git config --global user.email 'tu@email.com'"
    fi
}

# Iniciar servicios en background si es necesario
start_background_services() {
    log "Verificando servicios en background..."
    
    # AquÃ­ se pueden iniciar servicios como bases de datos, redis, etc.
    # Por ahora solo verificamos que no haya conflictos de puertos
    
    local ports=("4321" "3000")
    for port in "${ports[@]}"; do
        if lsof -i :$port >/dev/null 2>&1; then
            log_warning "Puerto $port ya estÃ¡ en uso"
        fi
    done
    
    log_success "VerificaciÃ³n de servicios completada"
}

# Mostrar estado del proyecto
show_project_status() {
    log "ðŸ“Š Estado del proyecto:"
    
    cd /workspace
    
    # InformaciÃ³n bÃ¡sica
    echo "  â€¢ Directorio: $(pwd)"
    echo "  â€¢ Branch: $(git branch --show-current 2>/dev/null || echo 'No es un repo git')"
    echo "  â€¢ Ãšltimo commit: $(git log -1 --oneline 2>/dev/null || echo 'No hay commits')"
    
    # Estado de archivos
    local modified_files=$(git status --porcelain 2>/dev/null | wc -l | tr -d ' ')
    if [ "$modified_files" -gt 0 ]; then
        echo "  â€¢ Archivos modificados: $modified_files"
    else
        echo "  â€¢ Working directory limpio"
    fi
    
    # InformaciÃ³n de dependencias
    if [ -f "package.json" ]; then
        local deps_count=$(jq '.dependencies | length' package.json 2>/dev/null || echo "?")
        local dev_deps_count=$(jq '.devDependencies | length' package.json 2>/dev/null || echo "?")
        echo "  â€¢ Dependencias: $deps_count production, $dev_deps_count development"
    fi
    
    echo ""
}

# Mostrar comandos Ãºtiles
show_quick_commands() {
    log "âš¡ Comandos rÃ¡pidos:"
    echo "  â€¢ make dev           - Iniciar desarrollo (http://localhost:4321)"
    echo "  â€¢ make build         - Construir para producciÃ³n"
    echo "  â€¢ make check         - Verificar tipos TypeScript"
    echo "  â€¢ make lint          - Ejecutar linter"
    echo "  â€¢ make help          - Ver todos los comandos"
    echo ""
    echo "  â€¢ tmux new -s dev    - Nueva sesiÃ³n de tmux"
    echo "  â€¢ tmux attach        - Conectar a sesiÃ³n existente"
    echo ""
    echo "  â€¢ nvim .             - Abrir proyecto en Neovim"
    echo "  â€¢ code .             - Abrir proyecto en VS Code"
    echo ""
}

# Verificar actualizaciones disponibles
check_updates() {
    log "Verificando actualizaciones..."
    
    cd /workspace
    
    # Verificar actualizaciones de dependencias (sin instalar)
    if command -v pnpm >/dev/null 2>&1; then
        local outdated=$(pnpm outdated --format=json 2>/dev/null | jq '. | length' 2>/dev/null || echo "0")
        if [ "$outdated" -gt 0 ]; then
            log_warning "$outdated dependencias tienen actualizaciones disponibles"
            echo "  Ejecuta 'pnpm outdated' para ver detalles"
        else
            log "Todas las dependencias estÃ¡n actualizadas"
        fi
    fi
}

# FunciÃ³n principal
main() {
    log "ðŸš€ Iniciando DevContainer..."
    
    check_dependencies
    cleanup_temp_files
    check_git_config
    start_background_services
    check_updates
    show_project_status
    show_quick_commands
    
    log_success "âœ… DevContainer listo para trabajar!"
    log "ðŸ’¡ Tip: Usa 'make help' para ver todos los comandos disponibles"
}

# Ejecutar funciÃ³n principal solo si no estamos en modo silencioso
if [ "${DEVCONTAINER_POST_START_SILENT:-}" != "true" ]; then
    main "$@"
fi