---
import { getImage } from "astro:assets";
import instagramData from "../../data/instagram";
import SectionWrapper from "../SectionWrapper.astro";
import GlassCard from "../GlassCard.astro";
import GallerySection from "./GallerySection";

interface Props {
  id: string;
  backgroundImage: string;
  title?: string;
  subtitle?: string;
  services?: any[];
}

const { id, backgroundImage, title, subtitle, services = [] } = Astro.props;

// Process posts to generate optimized images
const optimizedPosts = await Promise.all(
  instagramData.posts.map(async (post) => {
    if (post.isLocal && typeof post.imageUrl === "object") {
      try {
        const optimized = await getImage({
          src: post.imageUrl,
          format: "webp",
          width: 600,
          quality: 80,
        });

        return {
          ...post,
          imageUrl: optimized.src,
          srcSet: optimized.srcSet?.attribute || "",
          attributes: optimized.attributes,
        };
      } catch (e) {
        console.error(`Failed to optimize image for post ${post.id}`, e);
        return post;
      }
    }
    return post;
  }),
);

// Process artist profiles (if needed for avatars)
const optimizedArtists: Record<string, any> = {};
if (instagramData.artists) {
  for (const [key, artist] of Object.entries(instagramData.artists)) {
    let profilePic = artist.profile?.localProfilePic;

    if (
      artist.profile?.localProfilePic &&
      typeof artist.profile.localProfilePic === "object"
    ) {
      try {
        const optimized = await getImage({
          src: artist.profile.localProfilePic,
          format: "webp",
          width: 150,
          height: 150,
        });
        profilePic = optimized.src;
      } catch (e) {
        // fallback
      }
    }

    optimizedArtists[key] = {
      ...artist,
      profile: {
        ...artist.profile,
        localProfilePic: profilePic,
      },
      // We don't strictly need to pass the full posts array here if filtering is done on the main list
      // But preserving structure is safer
      posts: artist.posts.map(
        (p) => optimizedPosts.find((op) => op.id === p.id) || p,
      ),
    };
  }
}
---

<SectionWrapper id={id} backgroundImage={backgroundImage}>
  <GlassCard maxWidth="max-w-7xl">
    <div class="text-center mb-12">
      <h2 class="text-3xl md:text-5xl font-bold mb-4 tracking-tight">
        {title}
      </h2>
      {
        subtitle && (
          <p class="text-white/60 text-lg max-w-2xl mx-auto">{subtitle}</p>
        )
      }
    </div>
    <div class="space-y-8" data-animate>
      <GallerySection
        client:visible
        initialPosts={optimizedPosts as any}
        initialArtists={optimizedArtists as any}
        services={services}
      />
    </div>
  </GlassCard>
</SectionWrapper>
