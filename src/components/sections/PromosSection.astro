---
import SectionWrapper from "../SectionWrapper.astro";
import FlashDayModal from "../FlashDayModal.astro";

interface Props {
    id: string;
    backgroundImage: string;
    title?: string;
    subtitle?: string;
    promos?: {
        title: string;
        description: string;
        link?: string;
        date?: string;
        image?: ImageMetadata;
        images?: ImageMetadata[];
        type: "event" | "flash" | "promo";
        position?: number;
    }[];
}

const { id, backgroundImage, title, subtitle, promos = [] } = Astro.props;

// Sort promos by position if available
const sortedPromos = [...promos].sort(
    (a, b) => (a.position || 99) - (b.position || 99),
);

// Duplicate promos for infinite loop (ensure enough items to scroll)
// If fewer than 6 items, triple them. If fewer than 10, double them.
let displayPromos = sortedPromos;
if (sortedPromos.length > 0) {
    if (sortedPromos.length < 4) {
        displayPromos = [
            ...sortedPromos,
            ...sortedPromos,
            ...sortedPromos,
            ...sortedPromos,
        ];
    } else if (sortedPromos.length < 8) {
        displayPromos = [...sortedPromos, ...sortedPromos];
    }
}

// Prepare the list for marquee (double the display list to create the seamless loop)
// The key is that the marquee animation translates -50%, so we need two identical sets side-by-side.
const marqueePromos = [...displayPromos, ...displayPromos];
---

<SectionWrapper id={id} backgroundImage={backgroundImage}>
    <div class="w-full overflow-hidden py-12">
        <div class="text-center mb-12 px-4" data-animate>
            {
                title && (
                    <h2 class="text-gradient-white text-3xl sm:text-4xl lg:text-5xl font-bold tracking-tight mb-4">
                        {title}
                    </h2>
                )
            }
            {
                subtitle && (
                    <p class="text-white/60 text-lg max-w-2xl mx-auto">
                        {subtitle}
                    </p>
                )
            }
        </div>

        {/* Marquee Container */}
        <div class="marquee-container relative w-full group">
            {/* Gradient Masks */}
            <div
                class="absolute left-0 top-0 bottom-0 w-12 sm:w-32 bg-gradient-to-r from-black via-black/80 to-transparent z-20 pointer-events-none"
            >
            </div>
            <div
                class="absolute right-0 top-0 bottom-0 w-12 sm:w-32 bg-gradient-to-l from-black via-black/80 to-transparent z-20 pointer-events-none"
            >
            </div>

            <div
                class="marquee-track flex gap-6 w-max hover:[animation-play-state:paused]"
            >
                {
                    marqueePromos.map((promo, index) => {
                        // Determine images to show (single or array)
                        const imagesList =
                            promo.images && promo.images.length > 0
                                ? promo.images
                                : promo.image
                                  ? [promo.image]
                                  : [];
                        const hasCarousel = imagesList.length > 1;

                        return (
                            <a
                                href={promo.link || "#"}
                                class="promo-card group/card relative block w-[300px] sm:w-[350px] h-[450px] flex-shrink-0 rounded-[24px] overflow-hidden bg-white/5 border border-white/10 hover:border-white/20 transition-all duration-500 hover:shadow-[0_0_30px_rgba(200,149,108,0.15)] hover:scale-[1.02]"
                                data-index={index}
                            >
                                {/* Background Images (Carousel) */}
                                <div class="absolute inset-0 z-0 bg-black">
                                    {imagesList.map((imgSrc, imgIndex) => {
                                        if (!imgSrc) return null;
                                        return (
                                            <div
                                                class={`absolute inset-0 w-full h-full transition-opacity duration-1000 ${imgIndex === 0 ? "opacity-100" : "opacity-0"} ${hasCarousel ? "carousel-image" : ""}`}
                                                data-img-index={imgIndex}
                                            >
                                                <img
                                                    src={typeof imgSrc === 'string' ? imgSrc : imgSrc.src}
                                                    alt={`${promo.title} - ${imgIndex + 1}`}
                                                    class="w-full h-full object-cover"
                                                />
                                            </div>
                                        );
                                    })}
                                    <div class="absolute inset-0 bg-gradient-to-t from-black via-black/60 to-transparent z-10" />
                                </div>

                                {/* Badge */}
                                <div class="absolute top-4 right-4 z-20">
                                    <span
                                        class={`inline-flex items-center px-3 py-1 rounded-full text-xs font-medium uppercase tracking-wider backdrop-blur-md border ${
                                            promo.type === "flash"
                                                ? "bg-red-500/20 border-red-500/30 text-red-200"
                                                : promo.type === "event"
                                                  ? "bg-purple-500/20 border-purple-500/30 text-purple-200"
                                                  : "bg-[var(--color-gold)]/20 border-[var(--color-gold)]/30 text-[var(--color-gold)]"
                                        }`}
                                    >
                                        {promo.type}
                                    </span>
                                    {hasCarousel && (
                                        <span class="ml-2 inline-flex items-center px-2 py-1 rounded-full text-[10px] bg-black/50 border border-white/10 text-white/70 backdrop-blur-sm">
                                            Multiple
                                        </span>
                                    )}
                                </div>

                                {/* Content */}
                                <div class="relative z-20 h-full p-6 flex flex-col justify-end">
                                    {promo.date && (
                                        <p class="text-white/70 text-sm font-medium mb-2 uppercase tracking-wide">
                                            {promo.date}
                                        </p>
                                    )}
                                    <h3 class="text-2xl font-bold text-white mb-2 group-hover/card:text-[var(--color-gold)] transition-colors">
                                        {promo.title}
                                    </h3>
                                    <p class="text-white/60 text-sm line-clamp-3 group-hover/card:text-white/80 transition-colors">
                                        {promo.description}
                                    </p>

                                    <div class="mt-4 flex items-center gap-2 text-[var(--color-gold)] text-sm font-medium opacity-0 -translate-x-4 group-hover/card:opacity-100 group-hover/card:translate-x-0 transition-all duration-300 delay-100">
                                        <span>View Details</span>
                                        <svg
                                            class="w-4 h-4"
                                            fill="none"
                                            viewBox="0 0 24 24"
                                            stroke="currentColor"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M17 8l4 4m0 0l-4 4m4-4H3"
                                            />
                                        </svg>
                                    </div>
                                </div>
                            </a>
                        );
                    })
                }
            </div>
        </div>
    </div>
</SectionWrapper>

<FlashDayModal />

<style>
    .marquee-track {
        animation: marquee 40s linear infinite;
    }

    @keyframes marquee {
        0% {
            transform: translateX(0);
        }
        100% {
            transform: translateX(-50%);
        }
    }
</style>

<script>
    function initPromos() {
        // Handle Flash Day Modal Links
        const flashLinks = document.querySelectorAll('a[href="#flash-day"]');
        flashLinks.forEach((link) => {
            link.addEventListener("click", (e) => {
                e.preventDefault();
                if (window.openFlashModal) {
                    window.openFlashModal();
                } else {
                    console.warn("Flash Modal function not found");
                }
            });
        });

        // Simple Carousel Logic
        const cards = document.querySelectorAll(".promo-card");

        cards.forEach((card) => {
            const images = card.querySelectorAll(".carousel-image"); // select grid items
            if (images.length <= 1) return;

            let currentIndex = 0;
            let interval: ReturnType<typeof setInterval>;

            const startCarousel = () => {
                interval = setInterval(() => {
                    images[currentIndex].classList.remove("opacity-100");
                    images[currentIndex].classList.add("opacity-0");

                    currentIndex = (currentIndex + 1) % images.length;

                    images[currentIndex].classList.remove("opacity-0");
                    images[currentIndex].classList.add("opacity-100");
                }, 3000); // Change image every 3 seconds
            };

            // Stop carousel when card is not visible or destroyed (simple cleanup)
            // const stopCarousel = () => {
            //     clearInterval(interval);
            // };

            startCarousel();
        });
    }

    // Run on load
    initPromos();

    // Support View Transitions if added later
    document.addEventListener("astro:page-load", initPromos);
</script>
