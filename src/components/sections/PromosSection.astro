---
import SectionWrapper from "../SectionWrapper.astro";
import FlashDayModal from "../FlashDayModal.astro";

interface Props {
    id: string;
    backgroundImage: string;
    title?: string;
    subtitle?: string;
    promos?: {
        title: string;
        description: string;
        link?: string;
        date?: string;
        image?: ImageMetadata;
        images?: ImageMetadata[];
        type: "event" | "flash" | "promo";
        position?: number;
    }[];
}

const { id, backgroundImage, title, subtitle, promos = [] } = Astro.props;

// Sort promos by position if available
const sortedPromos = [...promos].sort(
    (a, b) => (a.position || 99) - (b.position || 99),
);

// Duplicate promos for infinite loop
let displayPromos = sortedPromos;
if (sortedPromos.length > 0) {
    if (sortedPromos.length < 4) {
        displayPromos = [
            ...sortedPromos,
            ...sortedPromos,
            ...sortedPromos,
            ...sortedPromos,
        ];
    } else if (sortedPromos.length < 8) {
        displayPromos = [...sortedPromos, ...sortedPromos];
    }
}

// Prepare the list for marquee (double the display list to create the seamless loop)
const marqueePromos = [...displayPromos, ...displayPromos];
---

<SectionWrapper id={id} backgroundImage={backgroundImage}>
    <div class="w-full overflow-hidden py-8 sm:py-12">
        <div class="text-center mb-8 sm:mb-12 px-5" data-animate>
            {
                title && (
                    <h2 class="text-gradient-white text-2xl sm:text-3xl lg:text-5xl font-bold tracking-tight mb-3 sm:mb-4">
                        {title}
                    </h2>
                )
            }
            {
                subtitle && (
                    <p class="text-white/50 text-sm sm:text-base lg:text-lg max-w-md sm:max-w-2xl mx-auto leading-relaxed">
                        {subtitle}
                    </p>
                )
            }
        </div>

        {/* Marquee Container */}
        <div class="marquee-container relative w-full group">
            {/* Gradient Masks â€” use surface color for seamless fade */}
            <div
                class="absolute left-0 top-0 bottom-0 w-8 sm:w-24 lg:w-32 z-20 pointer-events-none"
                style="background: linear-gradient(to right, var(--color-surface-primary), transparent);"
            >
            </div>
            <div
                class="absolute right-0 top-0 bottom-0 w-8 sm:w-24 lg:w-32 z-20 pointer-events-none"
                style="background: linear-gradient(to left, var(--color-surface-primary), transparent);"
            >
            </div>

            <div
                class="marquee-track flex gap-4 sm:gap-6 w-max hover:[animation-play-state:paused]"
            >
                {
                    marqueePromos.map((promo, index) => {
                        // Determine images to show (single or array)
                        const imagesList =
                            promo.images && promo.images.length > 0
                                ? promo.images
                                : promo.image
                                  ? [promo.image]
                                  : [];
                        const hasCarousel = imagesList.length > 1;

                        return (
                            <a
                                href={promo.link || "#"}
                                class="promo-card group/card relative block w-[260px] sm:w-[320px] lg:w-[350px] h-[380px] sm:h-[420px] lg:h-[450px] flex-shrink-0 rounded-[20px] sm:rounded-[24px] overflow-hidden bg-white/5 border border-white/[0.08] hover:border-white/20 transition-all duration-500 hover:shadow-[0_0_30px_rgba(200,149,108,0.15)] hover:scale-[1.02]"
                                data-index={index}
                            >
                                {/* Background Images (Carousel) */}
                                <div class="absolute inset-0 z-0 bg-black">
                                    {imagesList.map((imgSrc, imgIndex) => {
                                        if (!imgSrc) return null;
                                        return (
                                            <div
                                                class={`absolute inset-0 w-full h-full transition-opacity duration-1000 ${imgIndex === 0 ? "opacity-100" : "opacity-0"} ${hasCarousel ? "carousel-image" : ""}`}
                                                data-img-index={imgIndex}
                                            >
                                                <img
                                                    src={typeof imgSrc === 'string' ? imgSrc : imgSrc.src}
                                                    alt={`${promo.title} - ${imgIndex + 1}`}
                                                    class="w-full h-full object-cover"
                                                    loading="lazy"
                                                />
                                            </div>
                                        );
                                    })}
                                    <div class="absolute inset-0 bg-gradient-to-t from-black via-black/50 to-transparent z-10" />
                                </div>

                                {/* Badge */}
                                <div class="absolute top-3 right-3 sm:top-4 sm:right-4 z-20 flex items-center gap-1.5">
                                    <span
                                        class={`inline-flex items-center px-2.5 py-1 rounded-full text-[10px] sm:text-xs font-medium uppercase tracking-wider backdrop-blur-md border ${
                                            promo.type === "flash"
                                                ? "bg-red-500/20 border-red-500/30 text-red-200"
                                                : promo.type === "event"
                                                  ? "bg-purple-500/20 border-purple-500/30 text-purple-200"
                                                  : "bg-[var(--color-gold)]/20 border-[var(--color-gold)]/30 text-[var(--color-gold)]"
                                        }`}
                                    >
                                        {promo.type}
                                    </span>
                                    {hasCarousel && (
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-[9px] sm:text-[10px] bg-black/50 border border-white/10 text-white/60 backdrop-blur-sm">
                                            {imagesList.length} imgs
                                        </span>
                                    )}
                                </div>

                                {/* Content */}
                                <div class="relative z-20 h-full p-5 sm:p-6 flex flex-col justify-end">
                                    {promo.date && (
                                        <p class="text-white/60 text-xs sm:text-sm font-medium mb-1.5 sm:mb-2 uppercase tracking-wide">
                                            {promo.date}
                                        </p>
                                    )}
                                    <h3 class="text-xl sm:text-2xl font-bold text-white mb-1.5 sm:mb-2 group-hover/card:text-[var(--color-gold)] transition-colors leading-tight">
                                        {promo.title}
                                    </h3>
                                    <p class="text-white/50 text-xs sm:text-sm line-clamp-2 sm:line-clamp-3 group-hover/card:text-white/70 transition-colors">
                                        {promo.description}
                                    </p>

                                    <div class="mt-3 sm:mt-4 flex items-center gap-2 text-[var(--color-gold)] text-xs sm:text-sm font-medium opacity-0 -translate-x-3 group-hover/card:opacity-100 group-hover/card:translate-x-0 transition-all duration-300 delay-100">
                                        <span>View Details</span>
                                        <svg
                                            class="w-3.5 h-3.5 sm:w-4 sm:h-4"
                                            fill="none"
                                            viewBox="0 0 24 24"
                                            stroke="currentColor"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M17 8l4 4m0 0l-4 4m4-4H3"
                                            />
                                        </svg>
                                    </div>
                                </div>
                            </a>
                        );
                    })
                }
            </div>
        </div>
    </div>
</SectionWrapper>

<FlashDayModal />

<style>
    .marquee-track {
        animation: marquee 45s linear infinite;
    }

    /* Slower on mobile for readability */
    @media (max-width: 640px) {
        .marquee-track {
            animation-duration: 35s;
        }
    }

    @keyframes marquee {
        0% {
            transform: translateX(0);
        }
        100% {
            transform: translateX(-50%);
        }
    }

    @media (prefers-reduced-motion: reduce) {
        .marquee-track {
            animation: none;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
    }
</style>

<script>
    function initPromos() {
        // Handle Flash Day Modal Links
        const flashLinks = document.querySelectorAll('a[href="#flash-day"]');
        flashLinks.forEach((link) => {
            link.addEventListener("click", (e) => {
                e.preventDefault();
                if (window.openFlashModal) {
                    window.openFlashModal();
                } else {
                    console.warn("Flash Modal function not found");
                }
            });
        });

        // Simple Carousel Logic
        const cards = document.querySelectorAll(".promo-card");

        cards.forEach((card) => {
            const images = card.querySelectorAll(".carousel-image");
            if (images.length <= 1) return;

            let currentIndex = 0;

            setInterval(() => {
                images[currentIndex].classList.remove("opacity-100");
                images[currentIndex].classList.add("opacity-0");

                currentIndex = (currentIndex + 1) % images.length;

                images[currentIndex].classList.remove("opacity-0");
                images[currentIndex].classList.add("opacity-100");
            }, 3000);
        });
    }

    // Run on load
    initPromos();

    // Support View Transitions if added later
    document.addEventListener("astro:page-load", initPromos);
</script>
