---
import { getEntry } from "astro:content";

const studioEntry = await getEntry("studio", "main");
const videos = studioEntry?.data?.videos || [];
---

<section
    id="hero"
    class="lens-section cursor-none relative h-screen min-h-[600px] overflow-hidden bg-black"
    data-videos={JSON.stringify(videos)}
>
    {/* Blur Layer */}
    <div class="lens-blur-layer">
        <video
            autoplay
            loop
            muted
            playsinline
            class="w-full h-full object-cover hero-bg-img"
            src={videos[0]}
        >
        </video>
        <div
            class="absolute inset-0 bg-gradient-to-t from-[#050505] via-transparent to-black/10"
        >
        </div>
    </div>

    {/* Focus Layer */}
    <div class="lens-focus-layer">
        <video
            autoplay
            loop
            muted
            playsinline
            class="w-full h-full object-cover hero-bg-img"
            src={videos[0]}
        >
        </video>
        <div
            class="absolute inset-0 bg-gradient-to-t from-[#050505] via-transparent to-black/10"
        >
        </div>
    </div>

    {/* HUD Elements */}
    <div class="lens-hud" id="hero-lens-hud"></div>

    {/* Content Layer */}
    <div
        class="absolute inset-0 z-40 flex flex-col justify-center items-center text-center space-y-6 px-4 isolate pointer-events-none"
    >
        <div class="hero-item opacity-0 translate-y-10">
            <p
                class="text-xs md:text-sm font-mono text-neutral-400 uppercase tracking-[0.3em] mb-4 border-l border-r border-neutral-700 inline-block px-4 py-2 backdrop-blur-sm"
            >
                Est. Albuquerque, NM
            </p>
        </div>

        <div class="py-2">
            <img
                src="/logo.svg"
                alt="Logo"
                class="w-full h-auto max-w-[80vw] mx-auto"
            />
        </div>
        <div class="overflow-hidden py-2 hero-text-mask">
            <h1
                class="text-[15vw] md:text-[12vw] font-bold leading-[0.8] tracking-tighter text-transparent bg-clip-text bg-gradient-to-b from-neutral-200 to-neutral-800 hero-text-line"
            >
                ART &amp; INK
            </h1>
        </div>

        <div class="mt-12 hero-item opacity-0 translate-y-10">
            <a
                href="#book"
                class="pointer-events-auto inline-flex items-center gap-2 text-sm font-bold text-white uppercase tracking-widest hover:text-red-500 transition-colors group"
            >
                <span>Start Your Project</span>
                <i
                    data-lucide="arrow-right"
                    class="w-4 h-4 transform group-hover:translate-x-1 transition-transform"
                ></i>
            </a>
        </div>
    </div>
</section>

<style>
    /* --- LENS SECTION --- */
    .lens-section {
        --lens-x: 50%;
        --lens-y: 50%;
    }
    .lens-blur-layer {
        position: absolute;
        inset: 0;
        overflow: hidden;
        filter: grayscale(100%) blur(10px) brightness(0.3);
        transform: scale(1.1);
        z-index: 10;
    }
    .lens-focus-layer {
        position: absolute;
        inset: 0;
        overflow: hidden;
        mask-image: radial-gradient(
            200px circle at var(--lens-x) var(--lens-y),
            black 0%,
            transparent 100%
        );
        -webkit-mask-image: radial-gradient(
            200px circle at var(--lens-x) var(--lens-y),
            black 0%,
            transparent 100%
        );
        filter: grayscale(0%) contrast(1.1);
        transform: scale(1.1);
        z-index: 20;
    }
    .lens-hud {
        position: absolute;
        top: calc(var(--lens-y) - 100px);
        left: calc(var(--lens-x) - 100px);
        width: 200px;
        height: 200px;
        border: 1px solid transparent; /* Made transparent as requested */
        border-radius: 50%;
        z-index: 30;
        pointer-events: none;
        animation: spin 20s linear infinite;
        box-shadow: 1px solid transparent;
    }
    @keyframes spin {
        from {
            transform: rotate(0deg);
        }
        to {
            transform: rotate(360deg);
        }
    }
</style>

<script>
    import { gsap } from "gsap";
    import { ScrollTrigger } from "gsap/ScrollTrigger";

    gsap.registerPlugin(ScrollTrigger);

    // Random Video Logic (Synced)
    const heroSection = document.getElementById("hero");
    if (heroSection) {
        const videosData = heroSection.dataset.videos;
        if (videosData) {
            try {
                const videos = JSON.parse(videosData);
                if (Array.isArray(videos) && videos.length > 0) {
                    // Check if a video is already selected globally
                    let randomVideo = (window as any).sharedStudioVideo;

                    if (!randomVideo) {
                        randomVideo =
                            videos[Math.floor(Math.random() * videos.length)];
                        (window as any).sharedStudioVideo = randomVideo;
                    }

                    const videoElements =
                        heroSection.querySelectorAll("video.hero-bg-img");
                    videoElements.forEach((vid) => {
                        if (vid instanceof HTMLVideoElement) {
                            vid.src = randomVideo;
                            // Ensure it plays after swapping src
                            vid.load();
                            vid.play().catch((e) =>
                                console.log("Autoplay prevented:", e),
                            );
                        }
                    });
                }
            } catch (e) {
                console.error("Failed to parse hero videos:", e);
            }
        }
    }

    // Hero Lens Logic
    const lensHud = document.getElementById("hero-lens-hud");
    if (heroSection) {
        heroSection.addEventListener("mousemove", (e) => {
            const rect = heroSection.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            heroSection.style.setProperty("--lens-x", x + "px");
            heroSection.style.setProperty("--lens-y", y + "px");
            if (lensHud) {
                lensHud.style.left = x - 100 + "px";
                lensHud.style.top = y - 100 + "px";
            }
        });
    }

    // Hero Parallax & Reveal
    const heroTl = gsap.timeline({ delay: 0.2 });
    heroTl
        .from(".hero-text-line", {
            y: "100%",
            opacity: 0,
            duration: 1.2,
            ease: "power4.out",
            stagger: 0.15,
        })
        .to(
            ".hero-item",
            {
                opacity: 1,
                y: 0,
                duration: 0.8,
                ease: "power3.out",
                stagger: 0.1,
            },
            "-=0.5",
        );

    // Parallax Effect for Background Videos
    gsap.to(".hero-bg-img", {
        y: "15%",
        ease: "none",
        scrollTrigger: {
            trigger: "#hero",
            start: "top top",
            end: "bottom top",
            scrub: true,
        },
    });

    gsap.to(".hero-text-line", {
        scrollTrigger: {
            trigger: "body",
            start: "top top",
            end: "bottom top",
            scrub: 0.5,
            onUpdate: (self) => {
                const skew = self.getVelocity() / 300;
                gsap.set(".hero-text-line", {
                    skewX: Math.max(Math.min(skew, 5), -5),
                });
            },
        },
    });
</script>
