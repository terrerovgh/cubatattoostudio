---
import { getEntry } from "astro:content";

const studioEntry = await getEntry("studio", "main");
const videos = studioEntry?.data?.videos || [];
---

<section class="h-screen min-h-[600px] relative overflow-hidden">
    <div
        class="absolute inset-0 z-0 hero-bg-wrapper"
        data-videos={JSON.stringify(videos)}
    >
        <video
            autoplay
            loop
            muted
            playsinline
            class="w-full h-full object-cover hero-bg-img"
            src={videos[0]}
        >
        </video>
        <div
            class="absolute inset-0 bg-gradient-to-t from-[#050505] via-transparent to-black/10"
        >
        </div>
    </div>

    <div
        class="absolute inset-0 z-10 flex flex-col justify-center items-center text-center space-y-6 px-4 isolate"
    >
        <div class="hero-item opacity-0 translate-y-10">
            <p
                class="text-xs md:text-sm font-mono text-neutral-400 uppercase tracking-[0.3em] mb-4 border-l border-r border-neutral-700 inline-block px-4 py-2 backdrop-blur-sm"
            >
                Est. Albuquerque, NM
            </p>
        </div>

        {/* Grayscale Overlay Layer - punched out by logo */}
        <div
            class="absolute inset-0 bg-black/60 backdrop-grayscale pointer-events-none -z-10"
            aria-hidden="true"
        >
        </div>

        <div class="py-2 mix-blend-destination-out">
            <img
                src="/logo.svg"
                alt="Logo"
                class="w-full h-auto max-w-[80vw] mx-auto"
            />
        </div>
        <div class="overflow-hidden py-2 hero-text-mask">
            <h1
                class="text-[15vw] md:text-[12vw] font-bold leading-[0.8] tracking-tighter text-transparent bg-clip-text bg-gradient-to-b from-neutral-200 to-neutral-800 hero-text-line"
            >
                ART &amp; INK
            </h1>
        </div>

        <div class="mt-12 hero-item opacity-0 translate-y-10">
            <a
                href="#book"
                class="inline-flex items-center gap-2 text-sm font-bold text-white uppercase tracking-widest hover:text-red-500 transition-colors group"
            >
                <span>Start Your Project</span>
                <i
                    data-lucide="arrow-right"
                    class="w-4 h-4 transform group-hover:translate-x-1 transition-transform"
                ></i>
            </a>
        </div>
    </div>
</section>

<script>
    import { gsap } from "gsap";
    import { ScrollTrigger } from "gsap/ScrollTrigger";

    gsap.registerPlugin(ScrollTrigger);

    // Random Video Logic (Synced)
    const heroWrapper = document.querySelector(".hero-bg-wrapper");
    if (heroWrapper instanceof HTMLElement) {
        const videosData = heroWrapper.dataset.videos;
        if (videosData) {
            try {
                const videos = JSON.parse(videosData);
                if (Array.isArray(videos) && videos.length > 0) {
                    // Check if a video is already selected globally
                    let randomVideo = (window as any).sharedStudioVideo;

                    if (!randomVideo) {
                        randomVideo =
                            videos[Math.floor(Math.random() * videos.length)];
                        (window as any).sharedStudioVideo = randomVideo;
                    }

                    const videoElement =
                        heroWrapper.querySelector("video.hero-bg-img");
                    if (videoElement instanceof HTMLVideoElement) {
                        videoElement.src = randomVideo;
                        // Ensure it plays after swapping src
                        videoElement.load();
                        videoElement
                            .play()
                            .catch((e) =>
                                console.log("Autoplay prevented:", e),
                            );
                    }
                }
            } catch (e) {
                console.error("Failed to parse hero videos:", e);
            }
        }
    }

    // Hero Parallax & Reveal
    const heroTl = gsap.timeline({ delay: 0.2 });
    heroTl
        .from(".hero-text-line", {
            y: "100%",
            opacity: 0,
            duration: 1.2,
            ease: "power4.out",
            stagger: 0.15,
        })
        .to(
            ".hero-item",
            {
                opacity: 1,
                y: 0,
                duration: 0.8,
                ease: "power3.out",
                stagger: 0.1,
            },
            "-=0.5",
        );

    gsap.to(".hero-bg-img", {
        y: "15%",
        ease: "none",
        scrollTrigger: {
            trigger: ".hero-bg-wrapper",
            start: "top top",
            end: "bottom top",
            scrub: true,
        },
    });

    gsap.to(".hero-text-line", {
        scrollTrigger: {
            trigger: "body",
            start: "top top",
            end: "bottom top",
            scrub: 0.5,
            onUpdate: (self) => {
                const skew = self.getVelocity() / 300;
                gsap.set(".hero-text-line", {
                    skewX: Math.max(Math.min(skew, 5), -5),
                });
            },
        },
    });
</script>
