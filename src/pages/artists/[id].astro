---
import { getCollection } from "astro:content";
import { getImage } from "astro:assets";
import BaseLayout from "../../layouts/BaseLayout.astro";
import ArtistHero from "../../components/artist/ArtistHero.astro";
import CalendarNav from "../../components/artist/CalendarNav";
import PhotoGallery from "../../components/gallery/PhotoGallery";
import NinaAlgorithmicBackground from "../../components/artist/NinaAlgorithmicBackground";
import SplashCursor from "../../components/artist/SplashCursor";

export const prerender = true;

export async function getStaticPaths() {
  const artistEntries = await getCollection("artists");
  return artistEntries.map((entry) => ({
    params: { id: entry.data.id },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const config = entry.data;
const artistId = config.id;

const artistData = {
  ...config,
  id: artistId,
  fullName: config.name || config.displayName || artistId,
  displayName: config.displayName || config.name || artistId,
  role: config.role || "",
  bio: config.bio || "",
  profileImage: config.profileImage || `/artists/${artistId}.jpg`,
  styleDescription: config.styleDescription || "",
  signatureStyle: config.signatureStyle || "",
  instagram: config.socials?.instagram
    ? {
        username: config.socials.instagram,
        url: `https://instagram.com/${config.socials.instagram}`,
      }
    : null,
  specialties: config.specialties || [],
  services: config.services || [],
  gallery: config.gallery || [],
};

if (!artistData.id) {
  return Astro.redirect("/");
}

// Load gallery images from src/assets/gallery
const allGalleryImages = import.meta.glob<{ default: ImageMetadata }>(
  "/src/assets/gallery/**/*.{jpg,jpeg,png,webp}",
);

// Build curated gallery as PhotoGallery-compatible posts
const galleryPosts = await Promise.all(
  artistData.gallery.map(async (item: any, index: number) => {
    const imagePath = `/src/assets/gallery/${artistId}/${item.image}`;
    const loader = allGalleryImages[imagePath];

    let src = `/gallery/${artistId}/${item.image}`;
    let srcSet = "";
    let attributes: any = {};

    if (loader) {
      try {
        const imageModule = await loader();
        const optimized = await getImage({
          src: imageModule.default,
          format: "webp",
          width: 800,
          quality: 85,
        });
        src = optimized.src;
        srcSet = optimized.srcSet?.attribute || "";
        attributes = optimized.attributes || {};
      } catch (e) {
        // fallback to public path
      }
    }

    return {
      id: `${artistId}-${index}`,
      imageUrl: src,
      isLocal: true,
      srcSet,
      attributes,
      artist: artistId,
      caption: `Work by ${artistData.displayName}`,
    };
  }),
);

// Artist profile for lightbox sidebar
const galleryArtistProfile = {
  name: artistData.displayName,
  image: artistData.profileImage,
  role: artistData.role,
  id: artistId,
};

const pageTitle = `${artistData.displayName} — Cuba Tattoo Studio`;
const pageDescription =
  artistData.bio?.substring(0, 160) || `Portfolio of ${artistData.fullName}`;
---

<BaseLayout title={pageTitle} description={pageDescription} mode="artist">
  <style
    define:vars={{
      artistAccent: config.accentColor,
      artistAccentLight: config.accentColorLight,
      artistAccentDark: config.accentColorDark,
    }}
  ></style>

  {/* Background effects */}
  {
    config.constellation?.enabled && (
      <NinaAlgorithmicBackground
        client:only="react"
        accentColor={config.accentColor || '#ffffff'}
        constellation={{
          enabled: config.constellation?.enabled ?? true,
          colors: config.constellation?.colors ?? [],
          starDensity: config.constellation?.starDensity ?? 0.4,
          rotationSpeed: config.constellation?.rotationSpeed ?? 0.1,
          mandalas: config.constellation?.mandalas ?? [],
          roses: config.constellation?.roses ?? [],
          sacredGeometry: config.constellation?.sacredGeometry ?? false,
          geometricShapes: config.constellation?.geometricShapes ?? false,
          phyllotaxis: config.constellation?.phyllotaxis ?? false,
        }}
      />
    )
  }
  {
    config.splashCursor?.enabled && (
      <SplashCursor
        client:only="react"
        SIM_RESOLUTION={config.splashCursor.SIM_RESOLUTION}
        DYE_RESOLUTION={config.splashCursor.DYE_RESOLUTION}
        DENSITY_DISSIPATION={config.splashCursor.DENSITY_DISSIPATION}
        VELOCITY_DISSIPATION={config.splashCursor.VELOCITY_DISSIPATION}
        PRESSURE={config.splashCursor.PRESSURE}
        CURL={config.splashCursor.CURL}
        SPLAT_RADIUS={config.splashCursor.SPLAT_RADIUS}
        SPLAT_FORCE={config.splashCursor.SPLAT_FORCE}
        COLOR_UPDATE_SPEED={config.splashCursor.COLOR_UPDATE_SPEED}
      />
    )
  }

  {/* Top nav */}
  <nav
    class="fixed top-0 left-0 right-0 z-50 px-4 py-3"
    style="background: rgba(8, 8, 10, 0.6); backdrop-filter: blur(30px) saturate(1.5); -webkit-backdrop-filter: blur(30px) saturate(1.5); border-bottom: 1px solid rgba(255, 255, 255, 0.05);"
  >
    <div class="max-w-5xl mx-auto flex items-center justify-between">
      <a
        href="/"
        class="inline-flex items-center gap-2 text-sm text-white/50 hover:text-white transition-colors"
      >
        <svg
          class="w-4 h-4"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          stroke-width="2"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18"></path>
        </svg>
        <span class="hidden sm:inline">Cuba Tattoo Studio</span>
      </a>

      <span class="text-sm font-medium text-white/70"
        >{artistData.displayName}</span
      >

      <div class="flex items-center gap-3">
        {
          artistData.instagram && (
            <a
              href={`https://instagram.com/${artistData.instagram.username}`}
              target="_blank"
              rel="noopener noreferrer"
              class="text-white/40 hover:text-white transition-colors"
              aria-label="Instagram"
            >
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741 0 8.333.014 7.053.072 2.695.272.273 2.69.073 7.052.014 8.333 0 8.741 0 12c0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24c3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98C15.668.014 15.259 0 12 0zm0 5.838a6.162 6.162 0 100 12.324 6.162 6.162 0 000-12.324zM12 16a4 4 0 110-8 4 4 0 010 8zm6.406-11.845a1.44 1.44 0 100 2.881 1.44 1.44 0 000-2.881z" />
              </svg>
            </a>
          )
        }
        <a
          href="/booking"
          class="hidden sm:inline-flex items-center gap-1.5 px-4 py-1.5 rounded-lg text-xs font-semibold transition-all duration-300 hover:scale-[1.03]"
          style={`background: ${config.accentColor}; color: black;`}
        >
          Book Session
        </a>
      </div>
    </div>
  </nav>

  {
    /* ═══════════════════════════════════════════════════════════
      SECTION 1: Hero Card (Background + Photo + Description + Buttons)
      ═══════════════════════════════════════════════════════════ */
  }
  <div class="artist-page">
    <ArtistHero
      name={artistData.fullName}
      role={artistData.role}
      profileImage={artistData.profileImage}
      backgroundImage={config.backgroundImage || ''}
      bio={artistData.bio}
      instagram={artistData.instagram}
      accentColor={config.accentColor || '#ffffff'}
      displayName={artistData.displayName}
    />

    {
      /* ═══════════════════════════════════════════════════════════
        SECTION 2: Bio + Calendar — side by side
        ═══════════════════════════════════════════════════════════ */
    }
    <div class="grid-two-cards">
      {/* Bio Card */}
      <div class="glass-card" data-animate>
        <h3 class="card-title">Bio</h3>
        <p class="card-text">{artistData.styleDescription}</p>
        <p class="card-signature" style={`color: ${config.accentColor};`}>
          &ldquo;{artistData.signatureStyle}&rdquo;
        </p>
      </div>

      {/* Calendar Card */}
      {
        config.availability && (
          <div class="glass-card" data-animate>
            <h3 class="card-title">Calendar</h3>
            <CalendarNav
              client:visible
              schedule={config.availability.schedule || {}}
              blockedDates={config.availability.blockedDates}
              note={config.availability.note}
              accentColor={config.accentColor || '#ffffff'}
            />
          </div>
        )
      }
    </div>

    {
      /* ═══════════════════════════════════════════════════════════
        SECTION 3: Services — 3 circles
        ═══════════════════════════════════════════════════════════ */
    }
    {
      artistData.services.length > 0 && (
        <div class="services-row" data-animate>
          {artistData.services.map((service: any) => (
            <div class="service-item">
              <div
                class="service-circle"
                style={`border-color: ${config.accentColor}30; background: ${config.accentColor}08;`}
              >
                <span class="service-icon">{service.icon}</span>
              </div>
              <span class="service-label">{service.label}</span>
            </div>
          ))}
        </div>
      )
    }

    {
      /* ═══════════════════════════════════════════════════════════
        SECTION 4: Gallery — Masonry
        ═══════════════════════════════════════════════════════════ */
    }
    {
      galleryPosts.length > 0 && (
        <section class="gallery-section" id="gallery" data-section="gallery">
          <PhotoGallery
            client:visible
            posts={galleryPosts}
            accentColor={config.accentColor || '#ffffff'}
            artistProfile={galleryArtistProfile}
            artistLabels={{ [artistId]: artistData.displayName }}
          />
        </section>
      )
    }

    {/* Back to studio */}
    <div class="text-center pt-4 pb-8" data-animate>
      <a
        href="/"
        class="inline-flex items-center gap-2 px-6 py-3 rounded-xl text-sm font-medium text-white/50 hover:text-white bg-white/[0.03] border border-white/[0.06] hover:bg-white/[0.06] transition-all duration-300"
      >
        <svg
          class="w-4 h-4"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          stroke-width="2"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18"></path>
        </svg>
        Back to Studio
      </a>
    </div>
  </div>

  {/* Sticky mobile CTA */}
  <div
    class="fixed bottom-0 left-0 right-0 z-50 sm:hidden px-4 pb-[env(safe-area-inset-bottom,8px)] pt-3"
    style={`background: rgba(8, 8, 10, 0.85); backdrop-filter: blur(30px) saturate(1.5); -webkit-backdrop-filter: blur(30px) saturate(1.5); border-top: 1px solid rgba(255, 255, 255, 0.05);`}
  >
    <a
      href="/booking"
      class="flex items-center justify-center gap-2 w-full py-3.5 rounded-xl text-sm font-semibold text-black transition-all active:scale-[0.98]"
      style={`background: ${config.accentColor};`}
    >
      Book with {artistData.displayName}
      <svg
        class="w-4 h-4"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        stroke-width="2.5"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3"></path>
      </svg>
    </a>
  </div>
</BaseLayout>

<style>
  /* ─── Page Container ──────────────────────────────────── */
  .artist-page {
    max-width: 680px;
    margin: 0 auto;
    padding: 80px 16px 24px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  @media (min-width: 640px) {
    .artist-page {
      padding: 100px 24px 40px;
      gap: 20px;
    }
  }

  /* ─── Two-card grid (Bio + Calendar) ──────────────────── */
  .grid-two-cards {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }

  @media (min-width: 640px) {
    .grid-two-cards {
      gap: 20px;
    }
  }

  /* ─── Glass Card ──────────────────────────────────────── */
  .glass-card {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.06);
    border-radius: 16px;
    padding: 0.85rem;
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    overflow: hidden;
  }

  @media (min-width: 640px) {
    .glass-card {
      border-radius: 20px;
      padding: 1.25rem;
    }
  }

  .card-title {
    font-size: 0.85rem;
    font-weight: 700;
    color: white;
    margin-bottom: 0.5rem;
  }

  @media (min-width: 640px) {
    .card-title {
      font-size: 1.1rem;
      margin-bottom: 0.75rem;
    }
  }

  .card-text {
    font-size: 0.7rem;
    line-height: 1.6;
    color: rgba(255, 255, 255, 0.55);
    font-weight: 300;
  }

  @media (min-width: 640px) {
    .card-text {
      font-size: 0.8rem;
      line-height: 1.7;
    }
  }

  .card-signature {
    font-size: 0.65rem;
    font-style: italic;
    font-weight: 500;
    margin-top: 0.5rem;
  }

  @media (min-width: 640px) {
    .card-signature {
      font-size: 0.75rem;
      margin-top: 0.75rem;
    }
  }

  /* ─── Services Row ────────────────────────────────────── */
  .services-row {
    display: flex;
    justify-content: center;
    gap: 2rem;
    padding: 0.5rem 0;
  }

  .service-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
  }

  .service-circle {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    border: 1px solid;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
  }

  .service-circle:hover {
    transform: scale(1.08);
  }

  .service-icon {
    font-size: 1.5rem;
  }

  .service-label {
    font-size: 0.7rem;
    font-weight: 500;
    color: rgba(255, 255, 255, 0.6);
    text-align: center;
    max-width: 80px;
  }

  @media (min-width: 640px) {
    .service-circle {
      width: 76px;
      height: 76px;
    }

    .service-icon {
      font-size: 1.75rem;
    }

    .service-label {
      font-size: 0.75rem;
    }
  }

  /* ─── Gallery Section ────────────────────────────────── */
  .gallery-section {
    width: 100%;
  }
</style>
