# Makefile para Cuba Tattoo Studio
# Automatizaci√≥n del flujo de desarrollo

.PHONY: help install dev build preview check lint clean docker-build docker-dev docker-clean setup bootstrap dotfiles

# Variables
PROJECT_NAME := cubatattoostudio
DOCKER_IMAGE := $(PROJECT_NAME)-dev
DOCKER_CONTAINER := $(PROJECT_NAME)-container
NODE_VERSION := 20
PORT := 4321

# Colores para output
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[1;33m
BLUE := \033[0;34m
NC := \033[0m # No Color

# Funci√≥n para logging
define log
	@echo "$(BLUE)[$(shell date +'%H:%M:%S')]$(NC) $(1)"
endef

define log_success
	@echo "$(GREEN)[SUCCESS]$(NC) $(1)"
endef

define log_warning
	@echo "$(YELLOW)[WARNING]$(NC) $(1)"
endef

define log_error
	@echo "$(RED)[ERROR]$(NC) $(1)"
endef

# Ayuda por defecto
help: ## Mostrar esta ayuda
	@echo "$(BLUE)Cuba Tattoo Studio - Comandos disponibles:$(NC)"
	@echo ""
	@echo "$(YELLOW)üèóÔ∏è  Setup y Bootstrap:$(NC)"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  $(GREEN)%-15s$(NC) %s\n", $$1, $$2}' $(MAKEFILE_LIST) | grep -E "(bootstrap|setup|dotfiles)"
	@echo ""
	@echo "$(YELLOW)üì¶ Gesti√≥n de Dependencias:$(NC)"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  $(GREEN)%-15s$(NC) %s\n", $$1, $$2}' $(MAKEFILE_LIST) | grep -E "(install|clean)"
	@echo ""
	@echo "$(YELLOW)üöÄ Desarrollo:$(NC)"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  $(GREEN)%-15s$(NC) %s\n", $$1, $$2}' $(MAKEFILE_LIST) | grep -E "(dev|build|preview|check|lint)"
	@echo ""
	@echo "$(YELLOW)üê≥ Docker:$(NC)"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  $(GREEN)%-15s$(NC) %s\n", $$1, $$2}' $(MAKEFILE_LIST) | grep -E "docker"
	@echo ""
	@echo "$(YELLOW)‚òÅÔ∏è  Cloudflare:$(NC)"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  $(GREEN)%-15s$(NC) %s\n", $$1, $$2}' $(MAKEFILE_LIST) | grep -E "(deploy|pages)"
	@echo ""

# Setup y Bootstrap
bootstrap: ## Instalar dependencias del sistema y herramientas
	$(call log,"üöÄ Ejecutando bootstrap del sistema...")
	@chmod +x scripts/bootstrap.sh
	@./scripts/bootstrap.sh
	$(call log_success,"Bootstrap completado")

dotfiles: ## Configurar dotfiles (tmux, zsh, neovim, starship)
	$(call log,"üîß Configurando dotfiles...")
	@chmod +x scripts/setup-dotfiles.sh
	@./scripts/setup-dotfiles.sh
	$(call log_success,"Dotfiles configurados")

setup: ## Configurar entorno de desarrollo del proyecto
	$(call log,"‚öôÔ∏è Configurando proyecto...")
	@chmod +x scripts/dev-setup.sh
	@./scripts/dev-setup.sh
	$(call log_success,"Proyecto configurado")

full-setup: bootstrap dotfiles setup ## Configuraci√≥n completa (bootstrap + dotfiles + setup)
	$(call log_success,"üéâ Configuraci√≥n completa terminada!")

# Gesti√≥n de Dependencias
install: ## Instalar dependencias del proyecto
	$(call log,"üì¶ Instalando dependencias...")
	@if command -v pnpm >/dev/null 2>&1; then \
		pnpm install; \
	else \
		npm install; \
	fi
	$(call log_success,"Dependencias instaladas")

clean: ## Limpiar node_modules y archivos de build
	$(call log,"üßπ Limpiando archivos...")
	@rm -rf node_modules
	@rm -rf dist
	@rm -rf .astro
	@if command -v pnpm >/dev/null 2>&1; then pnpm store prune; fi
	$(call log_success,"Limpieza completada")

reset: clean install ## Reinstalar dependencias desde cero
	$(call log_success,"Reset completado")

# Desarrollo
dev: ## Iniciar servidor de desarrollo
	$(call log,"üöÄ Iniciando servidor de desarrollo en http://localhost:$(PORT)")
	@if command -v pnpm >/dev/null 2>&1; then \
		pnpm dev; \
	else \
		npm run dev; \
	fi

build: ## Construir para producci√≥n
	$(call log,"üèóÔ∏è Construyendo para producci√≥n...")
	@if command -v pnpm >/dev/null 2>&1; then \
		pnpm build; \
	else \
		npm run build; \
	fi
	$(call log_success,"Build completada")

preview: build ## Vista previa de la build de producci√≥n
	$(call log,"üëÄ Iniciando vista previa...")
	@if command -v pnpm >/dev/null 2>&1; then \
		pnpm preview; \
	else \
		npm run preview; \
	fi

check: ## Verificar tipos TypeScript
	$(call log,"üîç Verificando tipos...")
	@if command -v pnpm >/dev/null 2>&1; then \
		pnpm check; \
	else \
		npm run check; \
	fi
	$(call log_success,"Verificaci√≥n de tipos completada")

lint: ## Ejecutar linter
	$(call log,"üìù Ejecutando linter...")
	@if command -v pnpm >/dev/null 2>&1; then \
		pnpm lint; \
	else \
		npm run lint; \
	fi
	$(call log_success,"Linting completado")

test: check lint ## Ejecutar todas las verificaciones
	$(call log_success,"Todas las verificaciones completadas")

# Docker
docker-build: ## Construir imagen Docker para desarrollo
	$(call log,"üê≥ Construyendo imagen Docker...")
	@docker build -f .devcontainer/Dockerfile -t $(DOCKER_IMAGE) .
	$(call log_success,"Imagen Docker construida: $(DOCKER_IMAGE)")

docker-dev: ## Ejecutar contenedor de desarrollo
	$(call log,"üê≥ Iniciando contenedor de desarrollo...")
	@docker run -it --rm \
		--name $(DOCKER_CONTAINER) \
		-p $(PORT):$(PORT) \
		-p 3000:3000 \
		-v $(PWD):/workspace \
		-v /var/run/docker.sock:/var/run/docker.sock \
		-w /workspace \
		$(DOCKER_IMAGE) \
		zsh

docker-compose-up: ## Iniciar servicios con Docker Compose
	$(call log,"üê≥ Iniciando servicios con Docker Compose...")
	@cd .devcontainer && docker-compose up -d
	$(call log_success,"Servicios iniciados")

docker-compose-down: ## Detener servicios de Docker Compose
	$(call log,"üê≥ Deteniendo servicios...")
	@cd .devcontainer && docker-compose down
	$(call log_success,"Servicios detenidos")

docker-clean: ## Limpiar im√°genes y contenedores Docker
	$(call log,"üßπ Limpiando Docker...")
	@docker system prune -f
	@docker image prune -f
	$(call log_success,"Limpieza de Docker completada")

# Cloudflare Pages
pages-dev: ## Desarrollo con Wrangler Pages
	$(call log,"‚òÅÔ∏è Iniciando desarrollo con Wrangler...")
	@if command -v wrangler >/dev/null 2>&1; then \
		wrangler pages dev dist --port $(PORT); \
	else \
		$(call log_error,"Wrangler no est√° instalado. Ejecuta: npm install -g wrangler"); \
		exit 1; \
	fi

deploy: build ## Desplegar a Cloudflare Pages
	$(call log,"üöÄ Desplegando a Cloudflare Pages...")
	@if command -v wrangler >/dev/null 2>&1; then \
		wrangler pages publish dist; \
	else \
		$(call log_error,"Wrangler no est√° instalado. Ejecuta: npm install -g wrangler"); \
		exit 1; \
	fi
	$(call log_success,"Despliegue completado")

# Utilidades
info: ## Mostrar informaci√≥n del proyecto
	$(call log,"üìã Informaci√≥n del proyecto:")
	@echo "  Nombre: $(PROJECT_NAME)"
	@echo "  Node.js: $(shell node --version 2>/dev/null || echo 'No instalado')"
	@echo "  pnpm: $(shell pnpm --version 2>/dev/null || echo 'No instalado')"
	@echo "  Wrangler: $(shell wrangler --version 2>/dev/null || echo 'No instalado')"
	@echo "  Docker: $(shell docker --version 2>/dev/null || echo 'No instalado')"
	@echo "  Puerto: $(PORT)"

status: ## Mostrar estado de servicios
	$(call log,"üìä Estado de servicios:")
	@echo "  Contenedores Docker:"
	@docker ps --filter "name=$(DOCKER_CONTAINER)" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" 2>/dev/null || echo "    Ninguno ejecut√°ndose"
	@echo "  Procesos Node.js:"
	@pgrep -f "node.*$(PORT)" >/dev/null && echo "    Servidor ejecut√°ndose en puerto $(PORT)" || echo "    Ning√∫n servidor ejecut√°ndose"

# Shortcuts comunes
s: setup ## Shortcut para setup
i: install ## Shortcut para install
d: dev ## Shortcut para dev
b: build ## Shortcut para build
c: check ## Shortcut para check
l: lint ## Shortcut para lint

# Meta
.DEFAULT_GOAL := help